name: CD
on: [push]
jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Nix
        uses: cachix/install-nix-action@v17

      - name: Cachix
        uses: cachix/cachix-action@v10
        with:
          name: roguelike
          authToken: ${{ secrets.CACHIX_KEY }}

      - name: Build and Cache
        run:  nix-store -qR --include-outputs $(nix build --json | jq -r ".[].drvPath") | grep ".drv$" | cachix push roguelike

      - name: WASM Bindgen
        run:  nix develop --command wasm-bindgen ./result/bin/roguelike.wasm --out-dir public/wasm --no-modules --no-typescript

      - name: Deploy to GitHub Pages
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: gh-pages
          build_dir: public
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}